DEBUG: Main function started
DEBUG: Parsing prefill arguments
DEBUG: Prefill URLs parsed: [("http://0.0.0.0:20003", None)]
DEBUG: Filtering CLI arguments
DEBUG: Raw args: ["./target/debug/sglang-router", "--vllm-pd-disaggregation", "--policy", "consistent_hash", "--prefill", "http://0.0.0.0:20003", "--decode", "http://0.0.0.0:20005", "--host", "0.0.0.0", "--port", "10001", "--prometheus-host", "0.0.0.0", "--prometheus-port", "29000"]
DEBUG: Parsing CLI arguments with clap
DEBUG: Filtered args: ["./target/debug/sglang-router", "--vllm-pd-disaggregation", "--policy", "consistent_hash", "--decode", "http://0.0.0.0:20005", "--host", "0.0.0.0", "--port", "10001", "--prometheus-host", "0.0.0.0", "--prometheus-port", "29000"]
DEBUG: CLI args parsed successfully
DEBUG: pd_disaggregation: false
DEBUG: vllm_pd_disaggregation: true
SGLang Router starting...
Host: 0.0.0.0:10001
Mode: vLLM PD Disaggregated
Policy: consistent_hash
DEBUG: Converting to RouterConfig
DEBUG: RouterConfig created successfully
DEBUG: Validating configuration
DEBUG: Configuration validated successfully
DEBUG: Creating ServerConfig
DEBUG: ServerConfig created successfully
DEBUG: Creating Tokio runtime
DEBUG: Tokio runtime created successfully
DEBUG: Starting server startup function
DEBUG: Server startup function called
DEBUG: Initializing logging
DEBUG: Logging initialized
DEBUG: Initializing Prometheus metrics
DEBUG: Prometheus metrics initialized
[2m2025-09-17 21:39:42[0m [32m INFO[0m [2msglang_router_rs::server[0m[2m:[0m [2msrc/server.rs[0m[2m:[0m[2m574:[0m Starting router on 0.0.0.0:10001 | mode: VllmPrefillDecode { prefill_urls: [("http://0.0.0.0:20003", None)], decode_urls: ["http://0.0.0.0:20005"], prefill_policy: None, decode_policy: None } | policy: ConsistentHash { virtual_nodes: 160 } | max_payload: 512MB
DEBUG: Creating HTTP client
DEBUG: HTTP client created
DEBUG: Creating AppContext
DEBUG: AppContext created
[2m2025-09-17 21:39:42[0m [32m INFO[0m [2msglang_router_rs::server[0m[2m:[0m [2msrc/server.rs[0m[2m:[0m[2m671:[0m Single router mode (enable_igw=false)
[2m2025-09-17 21:39:42[0m [32m INFO[0m [2msglang_router_rs::routers::factory[0m[2m:[0m [2msrc/routers/factory.rs[0m[2m:[0m[2m84:[0m Creating VllmPDRouter with prefill_urls: [("http://0.0.0.0:20003", None)], decode_urls: ["http://0.0.0.0:20005"]
[2m2025-09-17 21:39:42[0m [32m INFO[0m [2msglang_router_rs::routers::factory[0m[2m:[0m [2msrc/routers/factory.rs[0m[2m:[0m[2m159:[0m About to create VllmPDRouter instance
[2m2025-09-17 21:39:42[0m [32m INFO[0m [2msglang_router_rs::routers::http::vllm_pd_router[0m[2m:[0m [2msrc/routers/http/vllm_pd_router.rs[0m[2m:[0m[2m133:[0m VllmPDRouter::new called with prefill_urls: [("http://0.0.0.0:20003", None)], decode_urls: ["http://0.0.0.0:20005"]
[2m2025-09-17 21:39:42[0m [32m INFO[0m [2msglang_router_rs::routers::http::router[0m[2m:[0m [2msrc/routers/http/router.rs[0m[2m:[0m[2m203:[0m Waiting for 2 workers to become healthy (timeout: 600s)
[2m2025-09-17 21:39:42[0m [32m INFO[0m [2msglang_router_rs::routers::http::router[0m[2m:[0m [2msrc/routers/http/router.rs[0m[2m:[0m[2m274:[0m All 2 workers are healthy
[2m2025-09-17 21:39:42[0m [32m INFO[0m [2msglang_router_rs::routers::http::vllm_pd_router[0m[2m:[0m [2msrc/routers/http/vllm_pd_router.rs[0m[2m:[0m[2m138:[0m VllmPDRouter created successfully, underlying PDRouter ready
[2m2025-09-17 21:39:42[0m [32m INFO[0m [2msglang_router_rs::routers::http::pd_router[0m[2m:[0m [2msrc/routers/http/pd_router.rs[0m[2m:[0m[2m493:[0m Prefill drain coordinator started
[2m2025-09-17 21:39:42[0m [32m INFO[0m [2msglang_router_rs::routers::factory[0m[2m:[0m [2msrc/routers/factory.rs[0m[2m:[0m[2m161:[0m VllmPDRouter instance created successfully
[2m2025-09-17 21:39:42[0m [32m INFO[0m [2msglang_router_rs::server[0m[2m:[0m [2msrc/server.rs[0m[2m:[0m[2m683:[0m Started health checker for workers with 60s interval
[2m2025-09-17 21:39:42[0m [32m INFO[0m [2msglang_router_rs::server[0m[2m:[0m [2msrc/server.rs[0m[2m:[0m[2m698:[0m Started request queue with size: 100, timeout: 60s
[2m2025-09-17 21:39:42[0m [32m INFO[0m [2msglang_router_rs::middleware[0m[2m:[0m [2msrc/middleware.rs[0m[2m:[0m[2m335:[0m Starting concurrency queue processor
[2m2025-09-17 21:39:42[0m [32m INFO[0m [2msglang_router_rs::server[0m[2m:[0m [2msrc/server.rs[0m[2m:[0m[2m734:[0m Router ready | workers: ["http://0.0.0.0:20003", "http://0.0.0.0:20005"]
[2m2025-09-17 21:39:42[0m [32m INFO[0m [2msglang_router_rs::server[0m[2m:[0m [2msrc/server.rs[0m[2m:[0m[2m758:[0m Starting server on 0.0.0.0:10001
[2m2025-09-17 21:40:22[0m [32m INFO[0m [1mhttp_request[0m[1m{[0m[3mmethod[0m[2m=[0mPOST [3muri[0m[2m=[0m/v1/completions [3mversion[0m[2m=[0mHTTP/1.1 [3mrequest_id[0m[2m=[0m"cmpl-g0o9ZTrQc86JTiFDa8ZbW9wc"[1m}[0m[2m:[0m [2msglang_router_rs::request[0m[2m:[0m [2msrc/middleware.rs[0m[2m:[0m[2m175:[0m started processing request
[2m2025-09-17 21:40:22[0m [32m INFO[0m [1mhttp_request[0m[1m{[0m[3mmethod[0m[2m=[0mPOST [3muri[0m[2m=[0m/v1/completions [3mversion[0m[2m=[0mHTTP/1.1 [3mrequest_id[0m[2m=[0m"cmpl-g0o9ZTrQc86JTiFDa8ZbW9wc"[1m}[0m[2m:[0m [2msglang_router_rs::routers::http::vllm_pd_router[0m[2m:[0m [2msrc/routers/http/vllm_pd_router.rs[0m[2m:[0m[2m259:[0m vLLM route_completion called
[2m2025-09-17 21:40:22[0m [32m INFO[0m [1mhttp_request[0m[1m{[0m[3mmethod[0m[2m=[0mPOST [3muri[0m[2m=[0m/v1/completions [3mversion[0m[2m=[0mHTTP/1.1 [3mrequest_id[0m[2m=[0m"cmpl-g0o9ZTrQc86JTiFDa8ZbW9wc"[1m}[0m[2m:[0m [2msglang_router_rs::routers::http::vllm_pd_router[0m[2m:[0m [2msrc/routers/http/vllm_pd_router.rs[0m[2m:[0m[2m264:[0m Serialized completion request: {
  "echo": false,
  "ignore_eos": false,
  "max_tokens": 5,
  "model": "meta-llama/Meta-Llama-3.1-8B-Instruct",
  "no_stop_trim": false,
  "prompt": "Hello world",
  "return_hidden_states": false,
  "skip_special_tokens": true,
  "stream": false,
  "temperature": 0.699999988079071
}
[2m2025-09-17 21:40:22[0m [32m INFO[0m [1mhttp_request[0m[1m{[0m[3mmethod[0m[2m=[0mPOST [3muri[0m[2m=[0m/v1/completions [3mversion[0m[2m=[0mHTTP/1.1 [3mrequest_id[0m[2m=[0m"cmpl-g0o9ZTrQc86JTiFDa8ZbW9wc"[1m}[0m[2m:[0m [2msglang_router_rs::routers::http::vllm_pd_router[0m[2m:[0m [2msrc/routers/http/vllm_pd_router.rs[0m[2m:[0m[2m275:[0m Built request for vLLM processing
[2m2025-09-17 21:40:22[0m [32m INFO[0m [1mhttp_request[0m[1m{[0m[3mmethod[0m[2m=[0mPOST [3muri[0m[2m=[0m/v1/completions [3mversion[0m[2m=[0mHTTP/1.1 [3mrequest_id[0m[2m=[0m"cmpl-g0o9ZTrQc86JTiFDa8ZbW9wc"[1m}[0m[2m:[0m [2msglang_router_rs::routers::http::vllm_pd_router[0m[2m:[0m [2msrc/routers/http/vllm_pd_router.rs[0m[2m:[0m[2m148:[0m vLLM handling request to path: /v1/completions
[2m2025-09-17 21:40:22[0m [32m INFO[0m [1mhttp_request[0m[1m{[0m[3mmethod[0m[2m=[0mPOST [3muri[0m[2m=[0m/v1/completions [3mversion[0m[2m=[0mHTTP/1.1 [3mrequest_id[0m[2m=[0m"cmpl-g0o9ZTrQc86JTiFDa8ZbW9wc"[1m}[0m[2m:[0m [2msglang_router_rs::policies::consistent_hash[0m[2m:[0m [2msrc/policies/consistent_hash.rs[0m[2m:[0m[2m282:[0m Updated consistent hash ring with 1 workers and 160 virtual nodes
[2m2025-09-17 21:40:22[0m [32m INFO[0m [1mhttp_request[0m[1m{[0m[3mmethod[0m[2m=[0mPOST [3muri[0m[2m=[0m/v1/completions [3mversion[0m[2m=[0mHTTP/1.1 [3mrequest_id[0m[2m=[0m"cmpl-g0o9ZTrQc86JTiFDa8ZbW9wc"[1m}[0m[2m:[0m [2msglang_router_rs::policies::consistent_hash[0m[2m:[0m [2msrc/policies/consistent_hash.rs[0m[2m:[0m[2m328:[0m CONSISTENT_HASH_DEBUG: No session_params.session_id found
[2m2025-09-17 21:40:22[0m [32m INFO[0m [1mhttp_request[0m[1m{[0m[3mmethod[0m[2m=[0mPOST [3muri[0m[2m=[0m/v1/completions [3mversion[0m[2m=[0mHTTP/1.1 [3mrequest_id[0m[2m=[0m"cmpl-g0o9ZTrQc86JTiFDa8ZbW9wc"[1m}[0m[2m:[0m [2msglang_router_rs::policies::consistent_hash[0m[2m:[0m [2msrc/policies/consistent_hash.rs[0m[2m:[0m[2m336:[0m CONSISTENT_HASH_DEBUG: No user field found
[2m2025-09-17 21:40:22[0m [32m INFO[0m [1mhttp_request[0m[1m{[0m[3mmethod[0m[2m=[0mPOST [3muri[0m[2m=[0m/v1/completions [3mversion[0m[2m=[0mHTTP/1.1 [3mrequest_id[0m[2m=[0m"cmpl-g0o9ZTrQc86JTiFDa8ZbW9wc"[1m}[0m[2m:[0m [2msglang_router_rs::policies::consistent_hash[0m[2m:[0m [2msrc/policies/consistent_hash.rs[0m[2m:[0m[2m524:[0m CONSISTENT_HASH_DEBUG: Extracted hash key: request:
[2m2025-09-17 21:40:22[0m [32m INFO[0m [1mhttp_request[0m[1m{[0m[3mmethod[0m[2m=[0mPOST [3muri[0m[2m=[0m/v1/completions [3mversion[0m[2m=[0mHTTP/1.1 [3mrequest_id[0m[2m=[0m"cmpl-g0o9ZTrQc86JTiFDa8ZbW9wc"[1m}[0m[2m:[0m [2msglang_router_rs::policies::consistent_hash[0m[2m:[0m [2msrc/policies/consistent_hash.rs[0m[2m:[0m[2m529:[0m CONSISTENT_HASH_DEBUG: Hash key 'request:' mapped to worker: http://0.0.0.0:20003
[2m2025-09-17 21:40:22[0m [32m INFO[0m [1mhttp_request[0m[1m{[0m[3mmethod[0m[2m=[0mPOST [3muri[0m[2m=[0m/v1/completions [3mversion[0m[2m=[0mHTTP/1.1 [3mrequest_id[0m[2m=[0m"cmpl-g0o9ZTrQc86JTiFDa8ZbW9wc"[1m}[0m[2m:[0m [2msglang_router_rs::policies::consistent_hash[0m[2m:[0m [2msrc/policies/consistent_hash.rs[0m[2m:[0m[2m558:[0m CONSISTENT_HASH_DEBUG: Target worker URL: http://0.0.0.0:20003, DP rank: None
[2m2025-09-17 21:40:22[0m [32m INFO[0m [1mhttp_request[0m[1m{[0m[3mmethod[0m[2m=[0mPOST [3muri[0m[2m=[0m/v1/completions [3mversion[0m[2m=[0mHTTP/1.1 [3mrequest_id[0m[2m=[0m"cmpl-g0o9ZTrQc86JTiFDa8ZbW9wc"[1m}[0m[2m:[0m [2msglang_router_rs::policies::consistent_hash[0m[2m:[0m [2msrc/policies/consistent_hash.rs[0m[2m:[0m[2m565:[0m CONSISTENT_HASH_DEBUG: Selected worker at index 0: http://0.0.0.0:20003
[2m2025-09-17 21:40:22[0m [32m INFO[0m [1mhttp_request[0m[1m{[0m[3mmethod[0m[2m=[0mPOST [3muri[0m[2m=[0m/v1/completions [3mversion[0m[2m=[0mHTTP/1.1 [3mrequest_id[0m[2m=[0m"cmpl-g0o9ZTrQc86JTiFDa8ZbW9wc"[1m}[0m[2m:[0m [2msglang_router_rs::policies::consistent_hash[0m[2m:[0m [2msrc/policies/consistent_hash.rs[0m[2m:[0m[2m566:[0m Consistent hash routing: key='request:' -> worker='http://0.0.0.0:20003' (index=0)
[2m2025-09-17 21:40:22[0m [32m INFO[0m [1mhttp_request[0m[1m{[0m[3mmethod[0m[2m=[0mPOST [3muri[0m[2m=[0m/v1/completions [3mversion[0m[2m=[0mHTTP/1.1 [3mrequest_id[0m[2m=[0m"cmpl-g0o9ZTrQc86JTiFDa8ZbW9wc"[1m}[0m[2m:[0m [2msglang_router_rs::policies::consistent_hash[0m[2m:[0m [2msrc/policies/consistent_hash.rs[0m[2m:[0m[2m282:[0m Updated consistent hash ring with 1 workers and 160 virtual nodes
[2m2025-09-17 21:40:22[0m [32m INFO[0m [1mhttp_request[0m[1m{[0m[3mmethod[0m[2m=[0mPOST [3muri[0m[2m=[0m/v1/completions [3mversion[0m[2m=[0mHTTP/1.1 [3mrequest_id[0m[2m=[0m"cmpl-g0o9ZTrQc86JTiFDa8ZbW9wc"[1m}[0m[2m:[0m [2msglang_router_rs::policies::consistent_hash[0m[2m:[0m [2msrc/policies/consistent_hash.rs[0m[2m:[0m[2m328:[0m CONSISTENT_HASH_DEBUG: No session_params.session_id found
[2m2025-09-17 21:40:22[0m [32m INFO[0m [1mhttp_request[0m[1m{[0m[3mmethod[0m[2m=[0mPOST [3muri[0m[2m=[0m/v1/completions [3mversion[0m[2m=[0mHTTP/1.1 [3mrequest_id[0m[2m=[0m"cmpl-g0o9ZTrQc86JTiFDa8ZbW9wc"[1m}[0m[2m:[0m [2msglang_router_rs::policies::consistent_hash[0m[2m:[0m [2msrc/policies/consistent_hash.rs[0m[2m:[0m[2m336:[0m CONSISTENT_HASH_DEBUG: No user field found
[2m2025-09-17 21:40:22[0m [32m INFO[0m [1mhttp_request[0m[1m{[0m[3mmethod[0m[2m=[0mPOST [3muri[0m[2m=[0m/v1/completions [3mversion[0m[2m=[0mHTTP/1.1 [3mrequest_id[0m[2m=[0m"cmpl-g0o9ZTrQc86JTiFDa8ZbW9wc"[1m}[0m[2m:[0m [2msglang_router_rs::policies::consistent_hash[0m[2m:[0m [2msrc/policies/consistent_hash.rs[0m[2m:[0m[2m524:[0m CONSISTENT_HASH_DEBUG: Extracted hash key: request:
[2m2025-09-17 21:40:22[0m [32m INFO[0m [1mhttp_request[0m[1m{[0m[3mmethod[0m[2m=[0mPOST [3muri[0m[2m=[0m/v1/completions [3mversion[0m[2m=[0mHTTP/1.1 [3mrequest_id[0m[2m=[0m"cmpl-g0o9ZTrQc86JTiFDa8ZbW9wc"[1m}[0m[2m:[0m [2msglang_router_rs::policies::consistent_hash[0m[2m:[0m [2msrc/policies/consistent_hash.rs[0m[2m:[0m[2m529:[0m CONSISTENT_HASH_DEBUG: Hash key 'request:' mapped to worker: http://0.0.0.0:20005
[2m2025-09-17 21:40:22[0m [32m INFO[0m [1mhttp_request[0m[1m{[0m[3mmethod[0m[2m=[0mPOST [3muri[0m[2m=[0m/v1/completions [3mversion[0m[2m=[0mHTTP/1.1 [3mrequest_id[0m[2m=[0m"cmpl-g0o9ZTrQc86JTiFDa8ZbW9wc"[1m}[0m[2m:[0m [2msglang_router_rs::policies::consistent_hash[0m[2m:[0m [2msrc/policies/consistent_hash.rs[0m[2m:[0m[2m558:[0m CONSISTENT_HASH_DEBUG: Target worker URL: http://0.0.0.0:20005, DP rank: None
[2m2025-09-17 21:40:22[0m [32m INFO[0m [1mhttp_request[0m[1m{[0m[3mmethod[0m[2m=[0mPOST [3muri[0m[2m=[0m/v1/completions [3mversion[0m[2m=[0mHTTP/1.1 [3mrequest_id[0m[2m=[0m"cmpl-g0o9ZTrQc86JTiFDa8ZbW9wc"[1m}[0m[2m:[0m [2msglang_router_rs::policies::consistent_hash[0m[2m:[0m [2msrc/policies/consistent_hash.rs[0m[2m:[0m[2m565:[0m CONSISTENT_HASH_DEBUG: Selected worker at index 0: http://0.0.0.0:20005
[2m2025-09-17 21:40:22[0m [32m INFO[0m [1mhttp_request[0m[1m{[0m[3mmethod[0m[2m=[0mPOST [3muri[0m[2m=[0m/v1/completions [3mversion[0m[2m=[0mHTTP/1.1 [3mrequest_id[0m[2m=[0m"cmpl-g0o9ZTrQc86JTiFDa8ZbW9wc"[1m}[0m[2m:[0m [2msglang_router_rs::policies::consistent_hash[0m[2m:[0m [2msrc/policies/consistent_hash.rs[0m[2m:[0m[2m566:[0m Consistent hash routing: key='request:' -> worker='http://0.0.0.0:20005' (index=0)
[2m2025-09-17 21:40:22[0m [32m INFO[0m [1mhttp_request[0m[1m{[0m[3mmethod[0m[2m=[0mPOST [3muri[0m[2m=[0m/v1/completions [3mversion[0m[2m=[0mHTTP/1.1 [3mrequest_id[0m[2m=[0m"cmpl-g0o9ZTrQc86JTiFDa8ZbW9wc"[1m}[0m[2m:[0m [2msglang_router_rs::routers::http::vllm_pd_router[0m[2m:[0m [2msrc/routers/http/vllm_pd_router.rs[0m[2m:[0m[2m177:[0m vLLM PD routing: prefill=http://0.0.0.0:20003, decode=http://0.0.0.0:20005
[2m2025-09-17 21:43:59[0m [32m INFO[0m [2msglang_router_rs::server[0m[2m:[0m [2msrc/server.rs[0m[2m:[0m[2m791:[0m Received terminate signal, starting graceful shutdown
[2m2025-09-17 21:43:59[0m [32m INFO[0m [2msglang_router_rs::routers::http::pd_router[0m[2m:[0m [2msrc/routers/http/pd_router.rs[0m[2m:[0m[2m552:[0m Prefill drain coordinator shutting down
[2m2025-09-17 21:43:59[0m [33m WARN[0m [2msglang_router_rs::middleware[0m[2m:[0m [2msrc/middleware.rs[0m[2m:[0m[2m375:[0m Concurrency queue processor shutting down
